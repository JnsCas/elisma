<!DOCTYPE html>
<html>
<head>
  <title>elisma</title>
  <style>
  </style>

  <link rel="stylesheet" href="/assets/css/isma.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    const CATEGORY_TITLES = {
      'web framework': 'Web Framework',
      'test framework': 'Test Framework',
      'logger': 'Logger',
      'database driver': 'Database Driver',
      'command line interface': 'Command Line Interface'
    }

    const disabledElements = (isLoading) => {
      $("#inputProjectName").prop("disabled", isLoading);

      if (!isLoading) {
        $("#inputProjectName").focus();
      }
    }

    const onError = (response) => {
      const errorMessage = response.responseText
      alert(errorMessage)
    }

    const showLanguages = (languages) => {
      const languageSelect = $("#languageSelect")
      languages.forEach(function(language) {
        languageSelect.append($("<option>").prop("value", language).text(language))
      });
    }

    const loadLanguages = () => {
      $.ajax({
        url: "http://localhost:9000/api/v1/languages",
        type: "GET",
        headers: {
          'x-session-id': sessionId
        },
        success: (response) => {
          showLanguages(response)
        },
        error: onError
      });
    }

    let sessionId
    $(document).ready(function() {
      disabledElements(true)
      $.ajax({
        url: "http://localhost:9000/api/v1/sessions",
        type: "POST",
        success: function(response) {
          sessionId = response.id
          disabledElements(false)
          loadLanguages()
        },
        error: onError
      });

      $("#languageSelect").on("change", () => {
        const selectedLanguage = $(this).val();
        $.ajax({
          url: "http://localhost:9000/api/v1/libs",
          type: "GET",
          headers: {
            'x-session-id': sessionId
          },
          success: (response) => {
            enableLibrariesSection(response)
          },
          error: onError
        });
      });

      $("#downloadZip").click(() => {
        disabledElements(true)
        const selectedLanguage = $("#languageSelect").val();
        const projectName = $("#inputProjectName").val();
        const selectedLibraries = []
        $('input[type="radio"]:checked').each(() => {
          const category = $(this).attr("name")
          const packageName = $(this).val()
          selectedLibraries.push({ category: category, packageName: packageName })
        })

        const payload = {
          selectedLanguage,
          projectName,
          selectedLibraries
        }

        $.ajax({
          url: "http://localhost:9000/api/v1/zip",
          type: "POST",
          data: JSON.stringify(payload),
          headers: {
            'x-session-id': sessionId
          },
          contentType: "application/json",
          success: (response) => {
            window.location = `http://localhost:9000/api/v1/download/${sessionId}`
          },
          error: onError
        });
      });
    });
  </script>
</head>
<body>
  <div class="content">
    <h1>El IsmA</h1>
    <br>
    <label for="languageSelect">Select Language</label>
    <select id="languageSelect"></select>
    <br>
    <label for="inputProjectName">Project Name</label><input type="text" id="inputProjectName">
    <br>
    <div id="radioList"></div>
    <br>
    <button id="downloadZip" hidden>Download Zip</button>
  </div>

  <canvas id="swarm"></canvas>

  <script type="text/javascript" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/188512/codepen-utilities.min.js"></script>
  <script type="text/javascript" src="/assets/js/brain.js"></script>
</body>
</html>
